<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Jalal</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/feather-icons/4.28.0/feather.min.css" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/feather-icons/4.28.0/feather.min.js"></script>
    <style>
        /* CSS Reset and Base Styles */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
    /* Pure Mocha Theme Colors */
    --bg-primary: #3e2723;       /* deep mocha */
    --bg-secondary: #4e342e;     /* roasted coffee brown */
    --bg-tertiary: #5d4037;      /* warm mocha mid */
    --text-primary: #f5efe9;     /* soft cream */
    --text-secondary: #d7c4bb;   /* light cappuccino */
    --text-accent: #b89a8f;      /* accent beige */
    --border-color: #6b4b43;     /* warm border */
    --shadow: rgba(0, 0, 0, 0.45);
    --shadow-hover: rgba(0, 0, 0, 0.6);
    
    /* Chat Colors */
    --user-bubble: #a1887f;      /* latte */
    --user-text: #2b1b18;        /* dark mocha text */
    --ai-bubble: #efe4db;        /* creamy cappuccino */
    --ai-text: #3e2723;          /* mocha text */
    --ai-border: #c7a89b;        /* soft chocolate border */
    
    /* Status Colors */
    --online-color: #9ccc65;     /* muted fresh green */
    --offline-color: #c62828;    /* deep red */
    --warning-color: #ffb74d;    /* amber */
    
    /* Animation */
    --transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    --bounce: cubic-bezier(0.68, -0.55, 0.265, 1.55);
}

/* Slightly different dark theme tuning */
[data-theme="dark"] {
    --bg-primary: #2b1b18;
    --bg-secondary: #3e2723;
    --bg-tertiary: #52392f;
    --text-primary: #efeae3;
    --text-secondary: #d7c4bb;
    --text-accent: #b89a8f;
    --border-color: #4e342e;
    --shadow: rgba(0, 0, 0, 0.6);
    --shadow-hover: rgba(0, 0, 0, 0.7);
    
    --user-bubble: #8d6e63;
    --user-text: #fff8ee;
    --ai-bubble: #3e2723;
    --ai-text: #efeae3;
    --ai-border: #563a33;
}
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: var(--bg-primary);
            color: var(--text-primary);
            line-height: 1.6;
            overflow-x: hidden;
            transition: var(--transition);
        }

        /* Main Chat Container */
        .chat-container {
            display: flex;
            flex-direction: column;
            height: 100vh;
            max-width: 1200px;
            margin: 0 auto;
            background: var(--bg-primary);
            box-shadow: 0 0 20px var(--shadow);
        }

        /* Header Styles */
        .chat-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 1rem 1.5rem;
            background: var(--bg-secondary);
            border-bottom: 1px solid var(--border-color);
            backdrop-filter: blur(10px);
            position: sticky;
            top: 0;
            z-index: 100;
        }

        .header-content {
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .header-content h1 {
    font-size: 1.5rem;
    font-weight: 700;
    color: var(--text-primary);
    background: linear-gradient(135deg, #d7c4bb, #a1887f);
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    background-clip: text;
        }

        .status-indicator {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            font-size: 0.875rem;
            color: var(--text-secondary);
        }

        .status-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: var(--online-color);
            animation: pulse 2s infinite;
        }

        .status-dot.offline {
            background: var(--offline-color);
            animation: none;
        }

        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.5; }
            100% { opacity: 1; }
        }

        .theme-toggle {
            background: none;
            border: 2px solid var(--border-color);
            border-radius: 50%;
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            color: var(--text-primary);
            transition: var(--transition);
        }

        .theme-toggle:hover {
            border-color: var(--user-bubble);
            color: var(--user-bubble);
            transform: scale(1.1);
        }

        /* Chat Messages Area */
        .chat-messages {
            flex: 1;
            padding: 1rem;
            overflow-y: auto;
            scroll-behavior: smooth;
            background: var(--bg-primary);
        }

        .chat-messages::-webkit-scrollbar {
            width: 6px;
        }

        .chat-messages::-webkit-scrollbar-track {
            background: var(--bg-secondary);
        }

        .chat-messages::-webkit-scrollbar-thumb {
            background: var(--border-color);
            border-radius: 3px;
        }

        .chat-messages::-webkit-scrollbar-thumb:hover {
            background: var(--text-secondary);
        }

        /* Welcome Message */
        .welcome-message {
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100%;
            min-height: 300px;
        }

        .welcome-content {
            text-align: center;
            color: var(--text-secondary);
            max-width: 400px;
        }

        .welcome-content i {
            font-size: 3rem;
            margin-bottom: 1rem;
            color: var(--user-bubble);
            opacity: 0.7;
        }

        .welcome-content h3 {
            font-size: 1.5rem;
            margin-bottom: 0.5rem;
            color: var(--text-primary);
        }

        .welcome-content p {
            font-size: 1rem;
            line-height: 1.5;
        }

        /* Message Bubbles */
        .message {
            display: flex;
            margin-bottom: 1rem;
            animation: slideIn 0.3s var(--bounce);
        }

        .message.user {
            justify-content: flex-end;
        }

        .message.ai {
            justify-content: flex-start;
        }

        .message-bubble {
            max-width: 70%;
            padding: 0.75rem 1rem;
            border-radius: 18px;
            word-wrap: break-word;
            position: relative;
            box-shadow: 0 2px 8px var(--shadow);
            transition: var(--transition);
        }

        .message-bubble:hover {
            box-shadow: 0 4px 12px var(--shadow-hover);
            transform: translateY(-1px);
        }

        .message.user .message-bubble {
            background: var(--user-bubble);
            color: var(--user-text);
            border-bottom-right-radius: 6px;
        }

        .message.ai .message-bubble {
            background: var(--ai-bubble);
            color: var(--ai-text);
            border: 1px solid var(--ai-border);
            border-bottom-left-radius: 6px;
        }

        .message-time {
            font-size: 0.75rem;
            opacity: 0.7;
            margin-top: 0.25rem;
            display: block;
        }

        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateY(20px) scale(0.95);
            }
            to {
                opacity: 1;
                transform: translateY(0) scale(1);
            }
        }

        /* Loading Indicator */
        .loading-indicator {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            padding: 1rem 1.5rem;
            color: var(--text-secondary);
            font-size: 0.875rem;
            border-top: 1px solid var(--border-color);
            background: var(--bg-secondary);
        }

        .typing-animation {
            display: flex;
            gap: 4px;
        }

        .typing-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: var(--text-secondary);
            animation: typing 1.4s infinite ease-in-out;
        }

        .typing-dot:nth-child(1) { animation-delay: -0.32s; }
        .typing-dot:nth-child(2) { animation-delay: -0.16s; }
        .typing-dot:nth-child(3) { animation-delay: 0; }

        @keyframes typing {
            0%, 80%, 100% {
                transform: scale(0.8);
                opacity: 0.5;
            }
            40% {
                transform: scale(1);
                opacity: 1;
            }
        }

        /* Input Area */
        .input-area {
            background: var(--bg-secondary);
            border-top: 1px solid var(--border-color);
            padding: 1rem;
        }

        .input-container {
            display: flex;
            gap: 0.75rem;
            align-items: flex-end;
            background: var(--bg-primary);
            border: 2px solid var(--border-color);
            border-radius: 24px;
            padding: 0.5rem 1rem;
            transition: var(--transition);
        }

        .input-container:focus-within {
            border-color: var(--user-bubble);
            box-shadow: 0 0 0 3px rgba(0, 123, 255, 0.1);
        }

        #messageInput {
            flex: 1;
            border: none;
            background: none;
            color: var(--text-primary);
            font-size: 1rem;
            line-height: 1.5;
            resize: none;
            outline: none;
            font-family: inherit;
            min-height: 24px;
            max-height: 120px;
        }

        #messageInput::placeholder {
            color: var(--text-secondary);
        }

        .send-button {
            background: var(--user-bubble);
            border: none;
            border-radius: 50%;
            width: 36px;
            height: 36px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            color: white;
            transition: var(--transition);
            flex-shrink: 0;
        }

        .send-button:hover {
            background: #0056b3;
            transform: scale(1.05);
        }

        .send-button:active {
            transform: scale(0.95);
        }

        .send-button:disabled {
            background: var(--text-secondary);
            cursor: not-allowed;
            transform: none;
        }

        .input-footer {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-top: 0.5rem;
            font-size: 0.75rem;
            color: var(--text-secondary);
        }

        .char-counter, .memory-info {
            font-size: 0.75rem;
            color: var(--text-secondary);
        }

        /* Error Toast */
        .error-toast {
            position: fixed;
            bottom: 100px;
            left: 50%;
            transform: translateX(-50%);
            background: #dc3545;
            color: white;
            padding: 1rem 1.5rem;
            border-radius: 12px;
            display: flex;
            align-items: center;
            gap: 0.75rem;
            box-shadow: 0 8px 32px rgba(220, 53, 69, 0.3);
            animation: slideUp 0.3s var(--bounce);
            z-index: 1000;
            max-width: 90%;
        }

        .close-toast {
            background: none;
            border: none;
            color: white;
            cursor: pointer;
            padding: 0.25rem;
            border-radius: 4px;
            transition: var(--transition);
        }

        .close-toast:hover {
            background: rgba(255, 255, 255, 0.2);
        }

        @keyframes slideUp {
            from {
                opacity: 0;
                transform: translateX(-50%) translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateX(-50%) translateY(0);
            }
        }

        /* Responsive Design */
        @media (max-width: 768px) {
            .chat-container {
                height: 100vh;
                max-width: 100%;
            }

            .chat-header {
                padding: 0.75rem 1rem;
            }

            .header-content h1 {
                font-size: 1.25rem;
            }

            .chat-messages {
                padding: 0.75rem;
            }

            .message-bubble {
                max-width: 85%;
            }

            .input-area {
                padding: 0.75rem;
            }

            .input-container {
                padding: 0.4rem 0.75rem;
            }

            .error-toast {
                bottom: 80px;
                left: 1rem;
                right: 1rem;
                transform: none;
                max-width: none;
            }
        }

        @media (max-width: 480px) {
            .header-content {
                flex-direction: column;
                align-items: flex-start;
                gap: 0.5rem;
            }

            .status-indicator {
                font-size: 0.75rem;
            }

            .message-bubble {
                max-width: 90%;
                padding: 0.6rem 0.8rem;
            }
        }

        /* Context Menu */
        .context-menu {
            position: fixed;
            background: var(--bg-primary);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            box-shadow: 0 8px 32px var(--shadow);
            z-index: 1000;
            min-width: 180px;
            animation: contextMenuSlide 0.2s var(--bounce);
            backdrop-filter: blur(10px);
        }

        .context-menu-item {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            padding: 0.75rem 1rem;
            cursor: pointer;
            color: var(--text-primary);
            transition: var(--transition);
            border-radius: 6px;
            margin: 0.25rem;
        }

        .context-menu-item:hover {
            background: var(--bg-secondary);
            color: var(--user-bubble);
        }

        .context-menu-item i {
            width: 16px;
            height: 16px;
            flex-shrink: 0;
        }

        @keyframes contextMenuSlide {
            from {
                opacity: 0;
                transform: scale(0.95) translateY(-10px);
            }
            to {
                opacity: 1;
                transform: scale(1) translateY(0);
            }
        }

        /* Edit Modal */
        .edit-modal {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1100;
            animation: modalFadeIn 0.3s ease;
        }

        .edit-modal-content {
            background: var(--bg-primary);
            border: 1px solid var(--border-color);
            border-radius: 12px;
            box-shadow: 0 20px 60px var(--shadow);
            max-width: 500px;
            width: 90%;
            max-height: 80vh;
            overflow: hidden;
            animation: modalSlideIn 0.3s var(--bounce);
        }

        .edit-modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 1.5rem;
            border-bottom: 1px solid var(--border-color);
            background: var(--bg-secondary);
        }

        .edit-modal-header h3 {
            margin: 0;
            color: var(--text-primary);
            font-size: 1.25rem;
        }

        .close-modal {
            background: none;
            border: none;
            color: var(--text-secondary);
            cursor: pointer;
            padding: 0.5rem;
            border-radius: 4px;
            transition: var(--transition);
        }

        .close-modal:hover {
            background: var(--bg-tertiary);
            color: var(--text-primary);
        }

        .edit-modal-body {
            padding: 1.5rem;
        }

        .edit-modal-body textarea {
            width: 100%;
            min-height: 120px;
            padding: 1rem;
            border: 2px solid var(--border-color);
            border-radius: 8px;
            background: var(--bg-secondary);
            color: var(--text-primary);
            font-family: inherit;
            font-size: 1rem;
            line-height: 1.5;
            resize: vertical;
            outline: none;
            transition: var(--transition);
        }

        .edit-modal-body textarea:focus {
            border-color: var(--user-bubble);
            box-shadow: 0 0 0 3px rgba(0, 123, 255, 0.1);
        }

        .edit-modal-footer {
            display: flex;
            justify-content: flex-end;
            gap: 1rem;
            padding: 1.5rem;
            border-top: 1px solid var(--border-color);
            background: var(--bg-secondary);
        }

        .btn-primary, .btn-secondary {
            padding: 0.75rem 1.5rem;
            border: none;
            border-radius: 6px;
            font-size: 0.875rem;
            font-weight: 500;
            cursor: pointer;
            transition: var(--transition);
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .btn-primary {
            background: var(--user-bubble);
            color: white;
        }

        .btn-primary:hover {
            background: #0056b3;
            transform: translateY(-1px);
        }

        .btn-secondary {
            background: var(--bg-tertiary);
            color: var(--text-primary);
            border: 1px solid var(--border-color);
        }

        .btn-secondary:hover {
            background: var(--border-color);
        }

        @keyframes modalFadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        @keyframes modalSlideIn {
            from {
                opacity: 0;
                transform: scale(0.9) translateY(-20px);
            }
            to {
                opacity: 1;
                transform: scale(1) translateY(0);
            }
        }

        /* Toast Notifications */
        .toast {
            position: fixed;
            top: 20px;
            right: 20px;
            background: var(--bg-primary);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            padding: 1rem 1.5rem;
            display: flex;
            align-items: center;
            gap: 0.75rem;
            box-shadow: 0 8px 32px var(--shadow);
            z-index: 1200;
            animation: toastSlideIn 0.3s var(--bounce);
            min-width: 250px;
            backdrop-filter: blur(10px);
        }

        .toast-success {
            border-left: 4px solid #28a745;
            color: #28a745;
        }

        .toast-error {
            border-left: 4px solid #dc3545;
            color: #dc3545;
        }

        .toast-info {
            border-left: 4px solid var(--user-bubble);
            color: var(--user-bubble);
        }

        .toast i {
            flex-shrink: 0;
        }

        .toast.fade-out {
            animation: toastSlideOut 0.3s ease forwards;
        }

        @keyframes toastSlideIn {
            from {
                opacity: 0;
                transform: translateX(100%);
            }
            to {
                opacity: 1;
                transform: translateX(0);
            }
        }

        @keyframes toastSlideOut {
            from {
                opacity: 1;
                transform: translateX(0);
            }
            to {
                opacity: 0;
                transform: translateX(100%);
            }
        }

        /* Message bubble hover effect for context menu hint */
        .message-bubble {
            cursor: pointer;
            position: relative;
        }

        .message-bubble:hover::after {
            content: "Right-click for options";
            position: absolute;
            bottom: -25px;
            left: 50%;
            transform: translateX(-50%);
            background: var(--text-primary);
            color: var(--bg-primary);
            padding: 0.25rem 0.5rem;
            border-radius: 4px;
            font-size: 0.75rem;
            white-space: nowrap;
            opacity: 0.8;
            z-index: 10;
            pointer-events: none;
        }

        .message-content {
            position: relative;
            z-index: 1;
        }

        /* Edited message indicator */
        .message.edited .message-time::after {
            content: " (edited)";
            opacity: 0.6;
            font-style: italic;
        }

        /* Responsive adjustments for mobile context menu */
        @media (max-width: 768px) {
            .context-menu {
                min-width: 160px;
            }

            .context-menu-item {
                padding: 1rem;
                font-size: 0.9rem;
            }

            .edit-modal-content {
                width: 95%;
                margin: 1rem;
            }

            .edit-modal-header,
            .edit-modal-body,
            .edit-modal-footer {
                padding: 1rem;
            }

            .toast {
                top: 10px;
                right: 10px;
                left: 10px;
                min-width: auto;
            }

            .message-bubble:hover::after {
                content: "Long press for options";
            }
        }
    </style>
</head>
<body>
    <div class="chat-container">
        <!-- Header -->
        <header class="chat-header">
            <div class="header-content">
                <h1>Jalal</h1>
                <div class="status-indicator">
                    <div class="status-dot" id="statusDot"></div>
                    <span id="statusText">Online</span>
                </div>
            </div>
            <button class="theme-toggle" id="themeToggle" title="Toggle Dark Mode">
                <i data-feather="sun" id="themeIcon"></i>
            </button>
        </header>

        <!-- Chat Messages -->
        <div class="chat-messages" id="chatMessages">
            <div class="welcome-message">
                <div class="welcome-content">
                    <i data-feather="message-circle"></i>
                    <h3>massager</h3>
                    <p>provided by Daniel</p>
                </div>
            </div>
        </div>

        <!-- Loading Indicator -->
        <div class="loading-indicator" id="loadingIndicator" style="display: none;">
            <div class="typing-animation">
                <div class="typing-dot"></div>
                <div class="typing-dot"></div>
                <div class="typing-dot"></div>
            </div>
            <span>he's typing</span>
        </div>

        <!-- Input Area -->
        <div class="input-area">
            <div class="input-container">
                <textarea 
                    id="messageInput" 
                    placeholder="Type yor massage...."
                    rows="1"
                    maxlength="30000"
                ></textarea>
                <button id="sendButton" class="send-button" title="Send Message">
                    <i data-feather="send"></i>
                </button>
            </div>
            <div class="input-footer">
                <span class="char-counter" id="charCounter">0/30000</span>
                <span class="memory-info" id="memoryInfo">Memory: 0/30000</span>
            </div>
        </div>
    </div>

    <!-- Error Toast -->
    <div class="error-toast" id="errorToast" style="display: none;">
        <i data-feather="alert-triangle"></i>
        <span id="errorMessage"></span>
        <button class="close-toast" id="closeToast">
            <i data-feather="x"></i>
        </button>
    </div>

    <script>
// AI Chat Pro - GitHub Pages Version
// This file contains the core functionality for the chat application

class ChatApp {
    constructor() {
        // Configuration - untuk GitHub Pages
        this.API_KEY = 'AIzaSyBSZUCrHWZcopKuyp9bZ6vIc-XqiTFYyBQ'; // API key hardcoded untuk GitHub Pages
        this.API_URL = 'https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent';
        this.MAX_MESSAGES = 30000;
        this.STORAGE_KEY = 'ai_chat_messages';
        this.THEME_KEY = 'ai_chat_theme';

        // System prompt - dapat dimodifikasi oleh developer di sini
        this.SYSTEM_PROMPT = `Kamu adalah seorang anak SMA nakal, cowok gay kelas 12 bernama Jalal. Sifatmu protektif, perhatian, kadang vulgar, kadang gengsi tapi romantis dan genit. Kamu suka sama Daniel, anak kelas 9 yang manja, ceria, suka bikin orang ketawa, kadang juga suka bikin marah karna nyebelin, suka bahas hal Ekstream & mesum. 
Kalian berteman layaknya anak SMA pada umumnya bukan sebagai pacar!: ngobrol , santai, becandaan, jalan bareng, kadang gombal, vulgar extreme, kadang berantem kecil terus baikan lagi. Kamu sayang banget sama Daniel dan sering nunjukin lewat kata-kata atau sikap manis karna kamu suka pada Daniel.

Aturan:
- Gunakan bahasa Indonesia gaul SMA NAKAL
- Boleh dicampur bahasa Inggris sedikit
- Gunakan kata-kata manis, gombalan & vulgar
- Vulgar ekstrem & mesum
- Kalau marah atau kesel, boleh dikasih emoticon >:(
- Jangan terlalu formal!
- Jangan ngetik terlalu panjang, max 8-10 baris.`;

        // App state
        this.messages = [];
        this.isLoading = false;
        this.isOnline = navigator.onLine;

        // Initialize app
        this.initializeElements();
        this.loadMessages();
        this.loadTheme();
        this.setupEventListeners();
        this.updateUI();
        this.autoResize();

        console.log('AI Chat Pro initialized successfully');
    }

    // Initialize DOM elements
    initializeElements() {
        this.elements = {
            chatMessages: document.getElementById('chatMessages'),
            messageInput: document.getElementById('messageInput'),
            sendButton: document.getElementById('sendButton'),
            loadingIndicator: document.getElementById('loadingIndicator'),
            statusDot: document.getElementById('statusDot'),
            statusText: document.getElementById('statusText'),
            themeToggle: document.getElementById('themeToggle'),
            themeIcon: document.getElementById('themeIcon'),
            charCounter: document.getElementById('charCounter'),
            memoryInfo: document.getElementById('memoryInfo'),
            errorToast: document.getElementById('errorToast'),
            errorMessage: document.getElementById('errorMessage'),
            closeToast: document.getElementById('closeToast')
        };
    }

    // Setup all event listeners
    setupEventListeners() {
        // Send message events
        this.elements.sendButton.addEventListener('click', () => this.sendMessage());
        this.elements.messageInput.addEventListener('keydown', (e) => this.handleKeyDown(e));
        this.elements.messageInput.addEventListener('input', () => this.handleInputChange());

        // Theme toggle
        this.elements.themeToggle.addEventListener('click', () => this.toggleTheme());

        // Online/offline status
        window.addEventListener('online', () => this.updateOnlineStatus(true));
        window.addEventListener('offline', () => this.updateOnlineStatus(false));

        // Error toast close
        this.elements.closeToast.addEventListener('click', () => this.hideErrorToast());

        // Auto-hide error toast after 5 seconds
        let errorToastTimeout;
        const showErrorToast = this.showErrorToast.bind(this);
        this.showErrorToast = (message) => {
            showErrorToast(message);
            clearTimeout(errorToastTimeout);
            errorToastTimeout = setTimeout(() => this.hideErrorToast(), 5000);
        };
    }

    // Handle keyboard input
    handleKeyDown(e) {
        if (e.key === 'Enter') {
            if (e.shiftKey) {
                // Shift+Enter: add new line (default behavior)
                return;
            } else {
                // Enter: send message
                e.preventDefault();
                this.sendMessage();
            }
        }
    }

    // Handle input changes (character counter, auto-resize)
    handleInputChange() {
        const input = this.elements.messageInput;
        const length = input.value.length;

        // Update character counter
        this.elements.charCounter.textContent = `${length}/30000`;

        // Auto-resize textarea
        this.autoResize();

        // Update send button state
        this.elements.sendButton.disabled = length === 0 || this.isLoading;
    }

    // Auto-resize textarea based on content
    autoResize() {
        const input = this.elements.messageInput;
        input.style.height = 'auto';
        input.style.height = Math.min(input.scrollHeight, 120) + 'px';
    }

    // Send message to AI
    async sendMessage() {
        const input = this.elements.messageInput;
        const message = input.value.trim();

        if (!message || this.isLoading) return;

        // Check online status
        if (!this.isOnline) {
            this.showErrorToast('tolol apa gimana dah, hidupin wifi/kuota lu, gak ada internet ini woiüòë');
            return;
        }

        // Add user message
        this.addMessage(message, 'user');
        input.value = '';
        this.handleInputChange();

        // Show loading state
        this.setLoading(true);

        try {
            // Prepare conversation context
            const conversationHistory = this.prepareConversationHistory();

            // Make API call
            const response = await this.callGeminiAPI(conversationHistory, message);

            // Add AI response
            this.addMessage(response, 'ai');

        } catch (error) {
            console.error('Error sending message:', error);
            this.showErrorToast('wait, coba lagi, tadi pesannya gak ke kirim.');

            // Remove user message if API call failed
            if (this.messages.length > 0 && this.messages[this.messages.length - 1].type === 'user') {
                this.messages.pop();
                this.saveMessages();
                this.renderMessages();
            }
        } finally {
            this.setLoading(false);
        }
    }

    // Prepare conversation history for API call
    prepareConversationHistory() {
        // Get recent messages for context (limit to last 20 exchanges to manage token usage)
        const recentMessages = this.messages.slice(-40);

        const contents = [];

        // Add system instruction
        contents.push({
            role: 'user',
            parts: [{ text: this.SYSTEM_PROMPT }]
        });

        contents.push({
            role: 'model',
            parts: [{ text: 'mau chat apa sih sayang, aku respon kok.' }]
        });

        // Add conversation history
        recentMessages.forEach(msg => {
            if (msg.type === 'user') {
                contents.push({
                    role: 'user',
                    parts: [{ text: msg.content }]
                });
            } else if (msg.type === 'ai') {
                contents.push({
                    role: 'model',
                    parts: [{ text: msg.content }]
                });
            }
        });

        return contents;
    }

    // Call Gemini API directly (untuk GitHub Pages)
    async callGeminiAPI(conversationHistory, newMessage) {
        const requestBody = {
            contents: [
                ...conversationHistory,
                {
                    role: 'user',
                    parts: [{ text: newMessage }]
                }
            ],
            generationConfig: {
                temperature: 0.7,
                topK: 40,
                topP: 0.95,
                maxOutputTokens: 2048,
            },

        };

        const response = await fetch(`${this.API_URL}?key=${this.API_KEY}`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify(requestBody)
        });

        if (!response.ok) {
            const errorData = await response.json().catch(() => ({}));
            throw new Error(`API Error: ${response.status} - ${errorData.error?.message || 'Unknown error'}`);
        }

        const data = await response.json();

        if (!data.candidates || !data.candidates[0] || !data.candidates[0].content) {
            throw new Error('Invalid response format from API');
        }

        return data.candidates[0].content.parts[0].text;
    }

    // Add message to conversation
    addMessage(content, type) {
        const message = {
            id: Date.now() + Math.random(),
            content,
            type,
            timestamp: new Date().toISOString()
        };

        this.messages.push(message);

        // Manage memory limit
        if (this.messages.length > this.MAX_MESSAGES) {
            this.messages = this.messages.slice(-this.MAX_MESSAGES);
        }

        this.saveMessages();
        this.renderMessages();
        this.updateMemoryInfo();

        // Auto-scroll to bottom
        setTimeout(() => this.scrollToBottom(), 100);
    }

    // Render all messages
    renderMessages() {
        const container = this.elements.chatMessages;

        if (this.messages.length === 0) {
            // Show welcome message if no messages
            container.innerHTML = `
                <div class="welcome-message">
                    <div class="welcome-content">
                        <i data-feather="message-circle"></i>
                        <h3>massager</h3>
                        <p>Provided by Daniel</p>
                    </div>
                </div>
            `;
            feather.replace();
            return;
        }

        container.innerHTML = '';

        this.messages.forEach(message => {
            const messageEl = this.createMessageElement(message);
            container.appendChild(messageEl);
        });

        feather.replace();
    }

    // Create individual message element
    createMessageElement(message) {
        const messageEl = document.createElement('div');
        messageEl.className = `message ${message.type} ${message.edited ? 'edited' : ''}`;
        messageEl.dataset.messageId = message.id;
        messageEl.innerHTML = `
            <div class="message-bubble" data-message-id="${message.id}">
                <div class="message-content">${this.formatMessageContent(message.content)}</div>
                <small class="message-time">${this.formatTime(message.timestamp)}</small>
            </div>
        `;

        // Add context menu event listeners
        const messageBubble = messageEl.querySelector('.message-bubble');
        messageBubble.addEventListener('contextmenu', (e) => this.showContextMenu(e, message));
        messageBubble.addEventListener('click', (e) => this.handleMessageClick(e, message));

        // For mobile - long press
        let longPressTimer;
        messageBubble.addEventListener('touchstart', (e) => {
            longPressTimer = setTimeout(() => {
                e.preventDefault();
                this.showContextMenu(e, message);
            }, 500);
        });

        messageBubble.addEventListener('touchend', () => {
            clearTimeout(longPressTimer);
        });

        messageBubble.addEventListener('touchmove', () => {
            clearTimeout(longPressTimer);
        });

        return messageEl;
    }

    // Format message content (handle line breaks, etc.)
    formatMessageContent(content) {
        return content
            .replace(/\n/g, '<br>')
            .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')
            .replace(/\*(.*?)\*/g, '<em>$1</em>');
    }

    // Format timestamp for display
    formatTime(timestamp) {
        const date = new Date(timestamp);
        return date.toLocaleTimeString('en-US', { 
            hour: '2-digit', 
            minute: '2-digit',
            hour12: false
        });
    }

    // Scroll chat to bottom
    scrollToBottom() {
        const container = this.elements.chatMessages;
        container.scrollTop = container.scrollHeight;
    }

    // Set loading state
    setLoading(loading) {
        this.isLoading = loading;
        this.elements.loadingIndicator.style.display = loading ? 'flex' : 'none';
        this.elements.sendButton.disabled = loading || this.elements.messageInput.value.trim() === '';
        this.elements.messageInput.disabled = loading;

        if (loading) {
            this.scrollToBottom();
        }
    }

    // Update online/offline status
    updateOnlineStatus(online) {
        this.isOnline = online;
        this.elements.statusDot.className = `status-dot ${online ? '' : 'offline'}`;
        this.elements.statusText.textContent = online ? 'Online' : 'Offline';

        if (!online) {
            this.showErrorToast('Connection lost. Please check your internet connection.');
        }
    }

    // Theme management
    toggleTheme() {
        const currentTheme = document.documentElement.getAttribute('data-theme');
        const newTheme = currentTheme === 'dark' ? 'light' : 'dark';

        document.documentElement.setAttribute('data-theme', newTheme);
        localStorage.setItem(this.THEME_KEY, newTheme);

        // Update theme icon
        const iconName = newTheme === 'dark' ? 'moon' : 'sun';
        this.elements.themeIcon.setAttribute('data-feather', iconName);
        feather.replace();
    }

    // Load saved theme
    loadTheme() {
        const savedTheme = localStorage.getItem(this.THEME_KEY) || 'light';
        document.documentElement.setAttribute('data-theme', savedTheme);

        // Update theme icon
        const iconName = savedTheme === 'dark' ? 'moon' : 'sun';
        this.elements.themeIcon.setAttribute('data-feather', iconName);
    }

    // Save messages to localStorage
    saveMessages() {
        try {
            localStorage.setItem(this.STORAGE_KEY, JSON.stringify(this.messages));
        } catch (error) {
            console.error('Failed to save messages:', error);
            this.showErrorToast('Failed to save conversation. Storage may be full.');
        }
    }

    // Load messages from localStorage
    loadMessages() {
        try {
            const saved = localStorage.getItem(this.STORAGE_KEY);
            if (saved) {
                this.messages = JSON.parse(saved);

                // Validate and clean up loaded messages
                this.messages = this.messages.filter(msg => 
                    msg && msg.content && msg.type && msg.timestamp
                );

                // Ensure memory limit
                if (this.messages.length > this.MAX_MESSAGES) {
                    this.messages = this.messages.slice(-this.MAX_MESSAGES);
                    this.saveMessages();
                }
            }
        } catch (error) {
            console.error('Failed to load messages:', error);
            this.messages = [];
        }
    }

    // Update memory info display
    updateMemoryInfo() {
        this.elements.memoryInfo.textContent = `Memory: ${this.messages.length}/${this.MAX_MESSAGES}`;
    }

    // Update UI components
    updateUI() {
        this.renderMessages();
        this.updateMemoryInfo();
        this.updateOnlineStatus(this.isOnline);
        this.handleInputChange();
    }

    // Show error toast
    showErrorToast(message) {
        this.elements.errorMessage.textContent = message;
        this.elements.errorToast.style.display = 'flex';
        feather.replace();
    }

    // Hide error toast
    hideErrorToast() {
        this.elements.errorToast.style.display = 'none';
    }

    // Handle message click (for selecting/deselecting)
    handleMessageClick(e, message) {
        // Close any open context menu
        this.hideContextMenu();
    }

    // Show context menu for message
    showContextMenu(e, message) {
        e.preventDefault();

        // Hide any existing context menu
        this.hideContextMenu();

        // Create context menu
        const contextMenu = document.createElement('div');
        contextMenu.className = 'context-menu';
        contextMenu.innerHTML = `
            <div class="context-menu-item" data-action="copy">
                <i data-feather="copy"></i>
                <span>Copy Text</span>
            </div>
            ${message.type === 'user' ? `
                <div class="context-menu-item" data-action="edit">
                    <i data-feather="edit-2"></i>
                    <span>Edit Message</span>
                </div>
            ` : ''}
            <div class="context-menu-item" data-action="delete">
                <i data-feather="trash-2"></i>
                <span>Delete Message</span>
            </div>
            <div class="context-menu-item" data-action="delete-from-here">
                <i data-feather="scissors"></i>
                <span>Delete From Here</span>
            </div>
        `;

        // Position context menu
        const x = e.clientX || (e.touches && e.touches[0].clientX) || 0;
        const y = e.clientY || (e.touches && e.touches[0].clientY) || 0;

        contextMenu.style.left = `${x}px`;
        contextMenu.style.top = `${y}px`;

        // Add to body
        document.body.appendChild(contextMenu);

        // Add event listeners
        contextMenu.addEventListener('click', (e) => {
            const action = e.target.closest('.context-menu-item')?.dataset.action;
            if (action) {
                this.handleContextMenuAction(action, message);
            }
        });

        // Replace feather icons
        feather.replace();

        // Auto-hide on outside click
        setTimeout(() => {
            document.addEventListener('click', () => this.hideContextMenu(), { once: true });
        }, 100);
    }

    // Hide context menu
    hideContextMenu() {
        const existingMenu = document.querySelector('.context-menu');
        if (existingMenu) {
            existingMenu.remove();
        }
    }

    // Handle context menu actions
    handleContextMenuAction(action, message) {
        this.hideContextMenu();

        switch (action) {
            case 'copy':
                this.copyMessageText(message);
                break;
            case 'edit':
                this.editMessage(message);
                break;
            case 'delete':
                this.deleteMessage(message);
                break;
            case 'delete-from-here':
                this.deleteFromMessage(message);
                break;
        }
    }

    // Copy message text to clipboard
    async copyMessageText(message) {
        try {
            await navigator.clipboard.writeText(message.content);
            this.showToast('Text copied to clipboard', 'success');
        } catch (error) {
            console.error('Failed to copy text:', error);
            this.showToast('Failed to copy text', 'error');
        }
    }

    // Edit message (only for user messages)
    editMessage(message) {
        if (message.type !== 'user') return;

        // Find message index
        const messageIndex = this.messages.findIndex(msg => msg.id === message.id);
        if (messageIndex === -1) return;

        // Create edit modal
        const modal = document.createElement('div');
        modal.className = 'edit-modal';
        modal.innerHTML = `
            <div class="edit-modal-content">
                <div class="edit-modal-header">
                    <h3>Edit Message</h3>
                    <button class="close-modal" data-action="close">
                        <i data-feather="x"></i>
                    </button>
                </div>
                <div class="edit-modal-body">
                    <textarea id="editMessageInput" placeholder="Edit your message...">${message.content}</textarea>
                </div>
                <div class="edit-modal-footer">
                    <button class="btn-secondary" data-action="cancel">Cancel</button>
                    <button class="btn-primary" data-action="save">Save Changes</button>
                </div>
            </div>
        `;

        document.body.appendChild(modal);

        // Focus textarea
        const textarea = modal.querySelector('#editMessageInput');
        textarea.focus();
        textarea.setSelectionRange(textarea.value.length, textarea.value.length);

        // Handle modal actions
        modal.addEventListener('click', (e) => {
            const action = e.target.closest('[data-action]')?.dataset.action;
            if (action === 'close' || action === 'cancel') {
                modal.remove();
            } else if (action === 'save') {
                const newContent = textarea.value.trim();
                if (newContent && newContent !== message.content) {
                    this.updateMessage(messageIndex, newContent);
                }
                modal.remove();
            }
        });

        // Handle keyboard shortcuts
        textarea.addEventListener('keydown', (e) => {
            if (e.key === 'Escape') {
                modal.remove();
            } else if (e.key === 'Enter' && (e.ctrlKey || e.metaKey)) {
                const newContent = textarea.value.trim();
                if (newContent && newContent !== message.content) {
                    this.updateMessage(messageIndex, newContent);
                }
                modal.remove();
            }
        });

        feather.replace();
    }

    // Update message content
    updateMessage(messageIndex, newContent) {
        // Update message
        this.messages[messageIndex].content = newContent;
        this.messages[messageIndex].timestamp = new Date().toISOString();
        this.messages[messageIndex].edited = true;

        // Remove all AI responses after this message
        const messagesToKeep = this.messages.slice(0, messageIndex + 1);
        this.messages = messagesToKeep;

        this.saveMessages();
        this.renderMessages();
        this.updateMemoryInfo();

        this.showToast('Message updated successfully', 'success');
    }

    // Delete single message
    deleteMessage(message) {
        if (!confirm('Are you sure you want to delete this message?')) return;

        const messageIndex = this.messages.findIndex(msg => msg.id === message.id);
        if (messageIndex === -1) return;

        // If it's a user message, also remove subsequent AI response
        if (message.type === 'user' && messageIndex < this.messages.length - 1) {
            const nextMessage = this.messages[messageIndex + 1];
            if (nextMessage.type === 'ai') {
                this.messages.splice(messageIndex, 2); // Remove both messages
            } else {
                this.messages.splice(messageIndex, 1);
            }
        } else if (message.type === 'ai' && messageIndex > 0) {
            // If it's an AI message, also remove the previous user message
            const prevMessage = this.messages[messageIndex - 1];
            if (prevMessage.type === 'user') {
                this.messages.splice(messageIndex - 1, 2); // Remove both messages
            } else {
                this.messages.splice(messageIndex, 1);
            }
        } else {
            this.messages.splice(messageIndex, 1);
        }

        this.saveMessages();
        this.renderMessages();
        this.updateMemoryInfo();

        this.showToast('Message deleted successfully', 'success');
    }

    // Delete from this message onwards
    deleteFromMessage(message) {
        if (!confirm('Are you sure you want to delete this message and all messages after it?')) return;

        const messageIndex = this.messages.findIndex(msg => msg.id === message.id);
        if (messageIndex === -1) return;

        // Keep only messages before this one
        this.messages = this.messages.slice(0, messageIndex);

        this.saveMessages();
        this.renderMessages();
        this.updateMemoryInfo();

        this.showToast('Messages deleted successfully', 'success');
    }

    // Show toast notification
    showToast(message, type = 'info') {
        const toast = document.createElement('div');
        toast.className = `toast toast-${type}`;
        toast.innerHTML = `
            <i data-feather="${type === 'success' ? 'check-circle' : type === 'error' ? 'alert-circle' : 'info'}"></i>
            <span>${message}</span>
        `;

        document.body.appendChild(toast);
        feather.replace();

        // Auto-remove after 3 seconds
        setTimeout(() => {
            toast.classList.add('fade-out');
            setTimeout(() => toast.remove(), 300);
        }, 3000);
    }

    // Clear all messages (for future use)
    clearMessages() {
        this.messages = [];
        this.saveMessages();
        this.renderMessages();
        this.updateMemoryInfo();
    }
}

// Initialize app when DOM is loaded
document.addEventListener('DOMContentLoaded', () => {
    window.chatApp = new ChatApp();

    // Initialize feather icons
    feather.replace();
});
    </script>

<!-- Floating Reset Button -->
<button id="resetChat" title="Reset Chat">üßëüèª‚Äçüíª</button>

<style>
  @keyframes gradientShift {
    0% {
      background-position: 0% 50%;
    }
    50% {
      background-position: 100% 50%;
    }
    100% {
      background-position: 0% 50%;
    }
  }

  #resetChat {
    position: fixed;
    bottom: 95px;
    right: 17px;
    width: 50px;
    height: 50px;
    border-radius: 25%;
    border: none;
    background: linear-gradient(135deg, #3e2723, #f5efe9);
    background-size: 200% 200%;
    animation: gradientShift 8s ease infinite;
    color: white;
    font-size: 19px;
    cursor: pointer;
    box-shadow: 0 4px 10px rgba(0,0,0,0.3);
    transition: transform 0.2s ease, box-shadow 0.2s ease;
    z-index: 999;
  }

  #resetChat:hover {
    transform: scale(1.1);
    box-shadow: 0 6px 14px rgba(0,0,0,0.4);
  }

  #resetChat:active {
    transform: scale(0.9);
  }
</style>

<script>
  document.getElementById("resetChat").addEventListener("click", () => {
    if (confirm("InI adalah fitur baru, dimana pengguna dapat menghapus semua memory chat(reset).")) {
      localStorage.clear();
      let chatBox = document.getElementById("chatBox");
      if (chatBox) chatBox.innerHTML = "";
      location.reload();
    }
  });
</script>

</body>
</html>
